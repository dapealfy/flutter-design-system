---
image:
  name: asia.gcr.io/amartha-dev/amartha/bitbucket-android-flutter-genymotion:1.13
  username: _json_key
  password: "$GCR_DEV_JSON_KEY"

definitions:
  caches:
    flutter-pub-cache: $PUB_CACHE
  steps:
    - step: &analyze-test
        name: Run tests
        script:
          - cd catalog && flutter pub get
          - cd .. && flutter pub get
          - flutter analyze
          - flutter test

    - step: &prepare-build
        name: Prepare build
        caches:
          - flutter-pub-cache
        script:
          - cd catalog
          - flutter pub get

    - step: &build-catalog
        name: Build catalog
        caches:
          - flutter-pub-cache
        script:
          - cd catalog
          - flutter build web --release --web-renderer canvaskit
        artifacts:
          - catalog/build/web/**


    - step: &build-apk-catalog
        name: Build APK catalog
        caches:
          - flutter-pub-cache
        script:
          - cd catalog
          - flutter build apk --release
        artifacts:
          - catalog/build/app/outputs/flutter-apk/app-release.apk

    - step: &deploy-catalog-main
        name: Deploy catalog main
        script:
          - cd catalog
          - curl -sL https://firebase.tools | bash
          - echo $FIREBASE_SERVICE_ACCOUNT | base64 -d > /tmp/firebase-service-account.json
          - export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
          - firebase deploy --only hosting --non-interactive

    - step: &deploy-catalog-preview
        name: Deploy catalog preview
        script:
          - cd catalog
          - curl -sL https://firebase.tools | bash
          - echo $FIREBASE_SERVICE_ACCOUNT | base64 -d > /tmp/firebase-service-account.json
          - export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
          - ./scripts/deploy_hosting_preview.sh

    - step: &distribute-apk
        name: Distribute apk to firebase
        script:
          - cd catalog/build/app/outputs/flutter-apk/
          - curl -sL https://firebase.tools | bash
          - echo $FIREBASE_SERVICE_ACCOUNT | base64 -d > /tmp/firebase-service-account.json
          - export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
          - firebase appdistribution:distribute app-release.apk --app 1:272130137531:android:5839788c41f2e388ee389e --groups "flutter-design-system"

    - step: &build-apk-with-tag
        name: Build APK catalog with tag name version
        caches:
          - flutter-pub-cache
        script:
          - cd catalog
          - flutter build apk --release --build-name=${BITBUCKET_TAG}
        artifacts:
          - catalog/build/app/outputs/flutter-apk/app-release.apk

    - step: &build-web-with-tag
        name: Build catalog
        caches:
          - flutter-pub-cache
        script:
          - cd catalog
          - flutter build web --release --web-renderer canvaskit --build-name=${BITBUCKET_TAG}
        artifacts:
          - catalog/build/web/**

clone:
  depth: full

pipelines:
  branches:
    master:
      - step: *analyze-test
      - step: *prepare-build
      - parallel:
        - step: *build-catalog
        - step: *build-apk-catalog
      - parallel:
        - step: *deploy-catalog-main
        - step: *distribute-apk
  custom:
    build-dev:
      - step: *prepare-build
      - step: *build-apk-catalog
      - step: *distribute-apk
  pull-requests:
    '{feature/*,bugfix/*}':
      - step: *analyze-test
      - step: *build-catalog
      - step: *deploy-catalog-preview
  tags:
    '*.*.*':
      - step: *prepare-build
      - step: *build-apk-with-tag
      - step: *distribute-apk
    '*.*':
      - step: *analyze-test
      - step: *prepare-build
      - parallel:
          - step: *build-web-with-tag
          - step: *build-apk-with-tag
      - parallel:
          - step: *deploy-catalog-main
          - step: *distribute-apk
